<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouthConnect Marketplace</title>
<link rel="stylesheet" href="../styles/nav.css">
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<style type="text/tailwindcss">
:root {
  --primary-color: #1173d4;
  --secondary-color: #e0effc;
  --background-color: #f8faff;
  --text-primary: #1a202c;
  --text-secondary: #5c6b8a;
}
body { font-family: 'Inter', sans-serif; background-color: var(--background-color); color: var(--text-primary); }
.form-input {
  @apply w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent transition-all duration-200 bg-white;
}
.form-select {
  -webkit-appearance: none; -moz-appearance: none; appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%234a5568' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 1rem center; background-size: 1.2em;
}
.icon-btn { display: inline-flex; align-items: center; justify-content: flex-start; gap: 6px; padding: 6px 12px; margin: 0; border-radius: 6px; font-size: 14px; cursor: pointer; transition: background 0.2s; }
.icon-btn.edit { background-color: #ffffff; color: black; } .icon-btn.edit:hover { background-color: #ffffff; }
.icon-btn.delete { background-color: #ffffff; color: black; } .icon-btn.delete:hover { background-color: #ffffff; }
.icon-btn.message { background-color: #ffffff; color: black; } .icon-btn.message:hover { background-color: #ffffff; }
.more-btn { position: absolute; bottom: 8px; right: 8px; cursor: pointer; font-size: 24px; color: #4a5568; }
.options-menu { display: none; position: absolute; bottom: 32px; right: 8px; background: white; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 50; flex-direction: column; min-width: 120px; }
.options-menu button, .options-menu a { display: flex; align-items: center; gap: 6px; padding: 6px 12px; font-size: 14px; width: 100%; }
#wordCount { text-align: right; font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; }
</style>
</head>
<body>
<%- include('partials/navigation') %>
<section class="main_content" id="mainContent">
<%- include('partials/topbar') %>

<main class="container mx-auto px-4 py-8 max-w-7xl">
  <div class="w-full">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-[var(--text-primary)]">Featured Products</h2>
      <button id="openProductForm" class="bg-[var(--primary-color)] text-white py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] focus:ring-opacity-50 transition-colors duration-200 font-semibold">
        Post New Product
      </button>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <% if (!products || products.length === 0) { %>
        <p class="text-gray-500">No products yet. Be the first to post!</p>
      <% } else { %>
        <% products.forEach(product => { %>
          <div class="relative bg-white rounded-lg shadow-sm overflow-hidden p-4 transition-shadow duration-300 hover:shadow-lg">
            <img src="<%= product.imageUrl %>" alt="<%= product.name %>" class="w-full h-48 object-cover rounded-lg"/>
            <div class="p-2 relative">
              <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-1"><%= product.name %></h3>
              <p class="text-sm text-[var(--text-secondary)] mb-2"><%= product.description %></p>
              <p class="text-sm text-[var(--text-secondary)]">Category: <%= product.category %></p>
              <p class="text-sm text-[var(--text-secondary)]">Condition: <%= product.condition %></p>
              <p class="text-xl font-bold text-[var(--primary-color)] mt-2">R<%= product.price %></p>

              <!-- Three dots more button -->
              <div class="more-btn">â‹®</div>

              <div class="options-menu flex flex-col">
                <% 
                  let showButtons = false; 
                  if (user && product.seller) {
                    if (product.seller._id) {
                      showButtons = product.seller._id.toString() === user._id.toString();
                    } else {
                      showButtons = product.seller.toString() === user._id.toString();
                    }
                  }
                %>
                <% if (showButtons) { %>
                  <button class="icon-btn edit edit-btn"
                          data-id="<%= product._id %>"
                          data-name="<%= product.name %>"
                          data-description="<%= product.description %>"
                          data-price="<%= product.price %>"
                          data-category="<%= product.category %>"
                          data-condition="<%= product.condition %>">
                    <span class="material-symbols-outlined">edit</span> Edit
                  </button>
                  <form action="/employer/marketplace/delete/<%= product._id %>" method="POST">
                    <button type="submit" class="icon-btn delete">
                      <span class="material-symbols-outlined">delete</span> Delete
                    </button>
                  </form>
                <% } %>
              <form action="/employer/<%= product._id %>/chat" method="POST">
    <button type="submit" class="icon-btn message">
      <span class="material-symbols-outlined">message</span> Message
    </button>
  </form>
              </div>

            </div>
          </div>
        <% }) %>
      <% } %>
    </div>
  </div>

  <!-- Modal for Posting / Editing Product -->
  <div id="productFormModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-8 shadow-lg rounded-xl border border-gray-200 max-w-3xl w-full mx-4 overflow-y-auto max-h-[90vh]">
      <div class="flex justify-between items-center mb-6">
        <h2 id="modalTitle" class="text-2xl font-extrabold text-[var(--text-primary)]">Post a New Product</h2>
        <button id="closeProductForm" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
      </div>
      <form id="productForm" class="space-y-6" action="/employer/marketplace" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="id" id="productId">
        <div>
          <label for="product-name" class="block text-sm font-medium text-[var(--text-secondary)] mb-2">Product Name</label>
          <input type="text" id="product-name" name="name" class="form-input" placeholder="e.g., Handcrafted Leather Wallet" required/>
        </div>
        <div>
          <label for="description" class="block text-sm font-medium text-[var(--text-secondary)] mb-2">Description (max 70 words)</label>
          <textarea id="description" name="description" rows="5" class="form-input placeholder:text-gray-400" placeholder="Describe your product" oninput="updateWordCount(this)"></textarea>
          <p id="wordCount">0 / 70 words</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="price" class="block text-sm font-medium text-[var(--text-secondary)] mb-2">Price (ZAR)</label>
            <div class="relative">
              <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                <span class="text-gray-500 sm:text-sm">R</span>
              </div>
              <input type="number" id="price" name="price" class="form-input pl-7 placeholder:text-gray-400" placeholder="150.00" required/>
            </div>
          </div>
          <div>
            <label for="category" class="block text-sm font-medium text-[var(--text-secondary)] mb-2">Category</label>
            <select id="category" name="category" class="form-input form-select" required>
              <option value="">Select a category</option>
              <option>Fashion & Apparel</option>
              <option>Electronics</option>
              <option>Home & Garden</option>
              <option>Arts & Crafts</option>
              <option>Other</option>
            </select>
          </div>
        </div>
        <div>
          <label for="condition" class="block text-sm font-medium text-[var(--text-secondary)] mb-2">Condition</label>
          <select id="condition" name="condition" class="form-input form-select" required>
            <option value="">Select condition</option>
            <option>New</option>
            <option>Used - Like New</option>
            <option>Used - Good</option>
            <option>Used - Fair</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">Product Image</label>
          <input type="file" name="image" accept="image/*"/>
        </div>
        <div class="flex justify-end">
          <button type="submit" class="bg-[var(--primary-color)] text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold transition-colors duration-200">Save Product</button>
        </div>
      </form>
    </div>
  </div>
</main>
</section>

<script>
// Modal open/close
const openBtn = document.getElementById("openProductForm");
const closeBtn = document.getElementById("closeProductForm");
const modal = document.getElementById("productFormModal");
const modalTitle = document.getElementById("modalTitle");
const form = document.getElementById("productForm");

openBtn.addEventListener("click", () => {
  modalTitle.textContent = "Post a New Product";
  form.action = "/employer/marketplace";
  document.getElementById("productId").value = "";
  form.reset();
  document.getElementById("wordCount").textContent = "0 / 70 words";
  modal.classList.remove("hidden"); modal.classList.add("flex");
});
closeBtn.addEventListener("click", () => { modal.classList.remove("flex"); modal.classList.add("hidden"); });
window.addEventListener("click", (e) => { if(e.target === modal){ modal.classList.remove("flex"); modal.classList.add("hidden"); } });

// Edit buttons in modal
document.querySelectorAll(".edit-btn").forEach(btn => {
  btn.addEventListener("click", (e) => {
    e.stopPropagation();
    modalTitle.textContent = "Edit Product";
    form.action = `/employer/marketplace/edit/${btn.dataset.id}`;
    document.getElementById("productId").value = btn.dataset.id;
    document.getElementById("product-name").value = btn.dataset.name;
    document.getElementById("description").value = btn.dataset.description;
    document.getElementById("price").value = btn.dataset.price;
    document.getElementById("category").value = btn.dataset.category;
    document.getElementById("condition").value = btn.dataset.condition;
    updateWordCount(document.getElementById("description"));
    modal.classList.remove("hidden"); modal.classList.add("flex");
  });
});

// Three dots toggle menu
document.querySelectorAll(".more-btn").forEach(dot => {
  dot.addEventListener("click", (e) => {
    e.stopPropagation();
    const menu = dot.nextElementSibling;
    menu.style.display = menu.style.display === "flex" ? "none" : "flex";
  });
});

// Close menus on outside click
window.addEventListener("click", () => {
  document.querySelectorAll(".options-menu").forEach(menu => menu.style.display = "none");
});

// Word count limit function
function updateWordCount(textarea) {
  let words = textarea.value.trim().split(/\s+/).filter(word => word.length > 0);
  if (words.length > 70) {
    words = words.slice(0, 70);
    textarea.value = words.join(" ");
  }
  document.getElementById("wordCount").textContent = `${words.length} / 70 words`;
}
</script>
<script src="../scripts/sidebar.js"></script>
</body>
</html>
